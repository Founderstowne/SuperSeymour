<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug SuperSeymour IndexedDB</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .button {
            display: inline-block;
            padding: 12px 30px;
            margin: 10px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .test-button {
            background: linear-gradient(135deg, #0066cc, #0099ff);
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,102,204,0.3);
        }

        .success {
            color: #00c853;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .info {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug SuperSeymour IndexedDB</h1>

        <div class="section">
            <h2>1. Check IndexedDB Contents</h2>
            <button class="button test-button" onclick="checkIndexedDB()">
                üîç Inspect IndexedDB
            </button>
            <div id="dbContents" class="code-block" style="margin-top: 20px; display: none;"></div>
        </div>

        <div class="section">
            <h2>2. Test Bookmarklet Code</h2>
            <button class="button test-button" onclick="testBookmarklet()">
                üß™ Test Loading from IndexedDB
            </button>
            <div id="bookmarkletTest" class="code-block" style="margin-top: 20px; display: none;"></div>
        </div>

        <div class="section">
            <h2>3. Manual Activation Test</h2>
            <button class="button test-button" onclick="manualActivate()">
                ‚ö° Manually Activate SuperSeymour
            </button>
            <div id="manualTest" style="margin-top: 20px;"></div>
        </div>

        <div class="info">
            <strong>üìã What This Does:</strong><br>
            ‚Ä¢ Checks if SuperSeymour code is properly stored in IndexedDB<br>
            ‚Ä¢ Verifies the code isn't corrupted<br>
            ‚Ä¢ Tests if the activation code can be loaded and executed<br>
            ‚Ä¢ Shows exactly what's happening when you click the bookmarklet
        </div>
    </div>

    <script>
        async function checkIndexedDB() {
            const output = document.getElementById('dbContents');
            output.style.display = 'block';
            output.innerHTML = 'Checking IndexedDB...\n\n';

            try {
                // Open the database
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('SuperSeymourDB', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('code')) {
                            db.createObjectStore('code');
                        }
                    };
                });

                output.innerHTML += '‚úÖ Database opened successfully\n\n';

                // Get all data from the store
                const tx = db.transaction(['code'], 'readonly');
                const store = tx.objectStore('code');

                // Get activation code
                const activation = await new Promise((resolve) => {
                    const request = store.get('activation');
                    request.onsuccess = () => resolve(request.result);
                });

                if (activation) {
                    output.innerHTML += '‚úÖ ACTIVATION CODE FOUND\n';
                    output.innerHTML += `   Size: ${activation.length} characters\n`;
                    output.innerHTML += `   First 200 chars: ${activation.substring(0, 200)}...\n\n`;

                    // Check if it's valid JavaScript
                    try {
                        new Function(activation);
                        output.innerHTML += '‚úÖ Code is valid JavaScript\n';
                    } catch(e) {
                        output.innerHTML += `‚ùå Code is NOT valid JavaScript: ${e.message}\n`;
                    }
                } else {
                    output.innerHTML += '‚ùå NO ACTIVATION CODE FOUND\n';
                }

                // Get metadata
                const metadata = await new Promise((resolve) => {
                    const request = store.get('metadata');
                    request.onsuccess = () => resolve(request.result);
                });

                if (metadata) {
                    output.innerHTML += '\n‚úÖ METADATA FOUND\n';
                    output.innerHTML += `   Version: ${metadata.version}\n`;
                    output.innerHTML += `   Installed: ${metadata.installedAt}\n`;
                    output.innerHTML += `   Size: ${metadata.size} bytes\n`;
                } else {
                    output.innerHTML += '\n‚ùå NO METADATA FOUND\n';
                }

                db.close();

            } catch(error) {
                output.innerHTML += `\n‚ùå ERROR: ${error.message}\n`;
            }
        }

        async function testBookmarklet() {
            const output = document.getElementById('bookmarkletTest');
            output.style.display = 'block';
            output.innerHTML = 'Testing bookmarklet loading...\n\n';

            try {
                // This simulates what the bookmarklet does
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('SuperSeymourDB', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('code')) {
                            db.createObjectStore('code');
                        }
                    };
                });

                const tx = db.transaction(['code'], 'readonly');
                const store = tx.objectStore('code');
                const code = await new Promise((resolve) => {
                    const request = store.get('activation');
                    request.onsuccess = () => resolve(request.result);
                });

                db.close();

                if (code) {
                    output.innerHTML += '‚úÖ Code loaded from IndexedDB\n';
                    output.innerHTML += `   Size: ${code.length} characters\n\n`;

                    // Try to execute it
                    try {
                        output.innerHTML += 'Attempting to execute code...\n';
                        eval(code);
                        output.innerHTML += '‚úÖ Code executed successfully!\n';
                        output.innerHTML += '\nLook for the SuperSeymour orb on this page!\n';
                    } catch(e) {
                        output.innerHTML += `‚ùå Code execution failed: ${e.message}\n`;
                        output.innerHTML += `\nStack trace:\n${e.stack}\n`;
                    }
                } else {
                    output.innerHTML += '‚ùå No code found in IndexedDB\n';
                    output.innerHTML += 'You need to install SuperSeymour first!\n';
                }

            } catch(error) {
                output.innerHTML += `‚ùå Error: ${error.message}\n`;
            }
        }

        async function manualActivate() {
            const output = document.getElementById('manualTest');

            try {
                // Load and execute the code directly
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('SuperSeymourDB', 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('code')) {
                            db.createObjectStore('code');
                        }
                    };
                });

                const tx = db.transaction(['code'], 'readonly');
                const store = tx.objectStore('code');
                const code = await new Promise((resolve) => {
                    const request = store.get('activation');
                    request.onsuccess = () => resolve(request.result);
                });

                db.close();

                if (code) {
                    console.log('‚úÖ SuperSeymour: Loading from IndexedDB cache');
                    eval(code);
                    output.innerHTML = '<p class="success">‚úÖ SuperSeymour activated! Look for the orb!</p>';
                } else {
                    output.innerHTML = '<p class="error">‚ùå No code in IndexedDB - please install first</p>';
                }

            } catch(error) {
                output.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                console.error('SuperSeymour error:', error);
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            console.log('Debug page loaded. Click the buttons to test SuperSeymour.');
        });
    </script>
</body>
</html>